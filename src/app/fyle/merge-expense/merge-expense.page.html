<ion-header class="fy-header" mode="md">
  <ion-toolbar mode="md" class="fy-header--toolbar">
    <ion-buttons mode="md" slot="start">
      <ion-back-button mode="md"></ion-back-button>
    </ion-buttons>
    <ion-title mode="md" class="fy-header--title"> Merge Duplicates </ion-title>
  </ion-toolbar>
</ion-header>

<ion-content>
  <ng-container *ngIf="fg">
    <form #formContainer [formGroup]="fg" class="merge-expenses--form" *ngIf="isLoaded">
      <div class="merge-expenses--internal-block">
        <ng-container *ngIf="expenseOptions$|async as expenseOptions">
          <app-fy-select
            [disabled]="false"
            [label]="'Expense to Keep'"
            [selectModalHeader]="'Expense to Keep'"
            [mandatory]="true"
            [nullOption]="false"
            [options]="expenseOptions"
            [enableSearch]="false"
            formControlName="target_txn_id"
          >
          </app-fy-select>
        </ng-container>
      </div>
      <div *ngIf="fg.controls.target_txn_id.touched && !fg.controls.target_txn_id.valid" class="merge-expenses--error">
        Please select a valid expense
      </div>

      <div class="merge-expenses--primary-block">
        <ion-grid class="merge-expenses--grid">
          <ion-row>
            <ion-col size="6">
              <ng-container>
                <div
                  [ngClass]="{'merge-expenses--internal-block_special': fg.controls.currencyObj.value}"
                  class="
                    merge-expenses--payment-modes merge-expenses--internal-block merge-expenses--internal-block__margin
                  "
                >
                  <app-fy-select
                    [enableSearch]="false"
                    [label]="'Currency'"
                    [mandatory]="false"
                    [nullOption]="false"
                    [disabled]="mergedExpenseOptions.tx_currency.isSame || ( mergedExpenseOptions.tx_currency.options && mergedExpenseOptions.tx_currency.options.length ===0 )"
                    [options]="mergedExpenseOptions.tx_currency.options"
                    [selectModalHeader]="'Select spend date'"
                    formControlName="currencyObj"
                  >
                  </app-fy-select>
                </div>
                <div
                  *ngIf="fg.controls.currencyObj.touched && !fg.controls.currencyObj.valid"
                  class="merge-expenses--error"
                >
                  Please select an amount
                </div>
              </ng-container>
            </ion-col>
            <ion-col size="6">
              <ng-container>
                <div
                  [ngClass]="{'merge-expenses--internal-block_special': fg.controls.amount.value}"
                  class="merge-expenses--payment-modes merge-expenses--internal-block"
                >
                  <app-fy-select
                    [enableSearch]="false"
                    [label]="'Amount'"
                    [mandatory]="false"
                    [nullOption]="false"
                    [disabled]="mergedExpenseOptions.tx_amount.isSame || ( mergedExpenseOptions.tx_amount.options && mergedExpenseOptions.tx_amount.options.length === 0)"
                    [options]="mergedExpenseOptions.tx_amount.options"
                    [selectModalHeader]="'Select Amount'"
                    formControlName="amount"
                  >
                  </app-fy-select>
                </div>
                <div *ngIf="fg.controls.amount.touched && !fg.controls.amount.valid" class="merge-expenses--error">
                  Please select a valid payment mode.
                </div>
              </ng-container>
            </ion-col>
          </ion-row>
        </ion-grid>
      </div>
      <ng-container>
        <div
          [ngClass]="{'merge-expenses--internal-block_special': fg.controls.vendor.value}"
          class="merge-expenses--payment-modes merge-expenses--internal-block"
        >
          <ng-container *ngIf="expenseOptions$|async as expenseOptions">
            <app-fy-select
              [enableSearch]="false"
              [label]="'Select receipt'"
              [mandatory]="true"
              [nullOption]="false"
              [options]="expenseOptions"
              [selectModalHeader]="'Select receipt'"
              formControlName="receipt_ids"
            >
            </app-fy-select>
          </ng-container>
        </div>
        <div *ngIf="fg.controls.dateOfSpend.touched && !fg.controls.dateOfSpend.valid" class="merge-expenses--error">
          Please select a valid payment mode.
        </div>
      </ng-container>
      <ng-container *ngIf="attachments$|async as attachments">
        <app-receipt-preview-thumbnail
          *ngIf="attachments.length > 0"
          [attachments]="attachments"
          [canEdit]="false"
          [hideLabel]="true"
        >
        </app-receipt-preview-thumbnail>
      </ng-container>

      <div class="merge-expenses--primary-block">
        <ion-grid class="merge-expenses--grid">
          <ion-row>
            <ion-col size="6">
              <ng-container>
                <div
                  [ngClass]="{'merge-expenses--internal-block_special': fg.controls.dateOfSpend.value}"
                  class="
                    merge-expenses--payment-modes merge-expenses--internal-block merge-expenses--internal-block__margin
                  "
                >
                  <app-fy-select
                    [enableSearch]="false"
                    [label]="'Date of Spend'"
                    [mandatory]="false"
                    [nullOption]="false"
                    [disabled]="mergedExpenseOptions.tx_txn_dt.isSame || ( mergedExpenseOptions.tx_txn_dt.options && mergedExpenseOptions.tx_txn_dt.options.length === 0)"
                    [options]="formatDateOptions(mergedExpenseOptions.tx_txn_dt.options)"
                    [selectModalHeader]="'Select spend date'"
                    formControlName="dateOfSpend"
                  >
                  </app-fy-select>
                </div>
                <div
                  *ngIf="fg.controls.dateOfSpend.touched && !fg.controls.dateOfSpend.valid"
                  class="merge-expenses--error"
                >
                  Please select a valid payment mode.
                </div>
              </ng-container>
            </ion-col>
            <ion-col size="6">
              <ng-container>
                <div
                  [ngClass]="{'merge-expenses--internal-block_special': fg.controls.paymentMode.value}"
                  class="merge-expenses--payment-modes merge-expenses--internal-block"
                >
                  <app-fy-select
                    [enableSearch]="false"
                    [label]="'Payment Mode'"
                    [mandatory]="true"
                    [nullOption]="false"
                    [disabled]="mergedExpenseOptions.source_account_type.isSame || ( mergedExpenseOptions.source_account_type.options && mergedExpenseOptions.source_account_type.options.length === 0)"
                    [options]="formatPaymentModeOptions(mergedExpenseOptions.source_account_type.options)"
                    [selectModalHeader]="'Select Payment Mode'"
                    formControlName="paymentMode"
                  >
                  </app-fy-select>
                </div>
                <div
                  *ngIf="fg.controls.paymentMode.touched && !fg.controls.paymentMode.valid"
                  class="merge-expenses--error"
                >
                  Please select a valid payment mode.
                </div>
              </ng-container>
            </ion-col>
          </ion-row>
        </ion-grid>
      </div>

      <div class="merge-expenses--primary-block">
        <ion-grid class="merge-expenses--grid">
          <ion-row>
            <ion-col size="6">
              <ng-container>
                <div
                  [ngClass]="{'merge-expenses--internal-block_special': fg.controls.project.value}"
                  class="
                    merge-expenses--payment-modes merge-expenses--internal-block merge-expenses--internal-block__margin
                  "
                >
                  <app-fy-select
                    [enableSearch]="false"
                    [label]="'Project'"
                    [mandatory]="false"
                    [nullOption]="false"
                    [disabled]="mergedExpenseOptions.tx_project_id.isSame || (mergedExpenseOptions.tx_project_id.options && mergedExpenseOptions.tx_project_id.options.length === 0)"
                    [options]="mergedExpenseOptions.tx_project_id.options"
                    [selectModalHeader]="'Select project'"
                    formControlName="project"
                  >
                  </app-fy-select>
                </div>
                <div
                  *ngIf="fg.controls.currencyObj.touched && !fg.controls.currencyObj.valid"
                  class="merge-expenses--error"
                >
                  Please select an amount
                </div>
              </ng-container>
            </ion-col>
            <ion-col size="6">
              <ng-container>
                <div
                  [ngClass]="{'merge-expenses--internal-block_special': fg.controls.billable.value}"
                  class="merge-expenses--payment-modes merge-expenses--internal-block"
                >
                  <app-fy-select
                    [enableSearch]="false"
                    [label]="'Billable'"
                    [mandatory]="false"
                    [nullOption]="false"
                    [disabled]="mergedExpenseOptions.tx_billable.isSame || ( mergedExpenseOptions.tx_billable.options && mergedExpenseOptions.tx_billable.options.length === 0)"
                    [options]="formatBillableOptions(mergedExpenseOptions.tx_billable.options)"
                    [selectModalHeader]="'Select billable'"
                    formControlName="billable"
                  >
                  </app-fy-select>
                </div>
                <div *ngIf="fg.controls.billable.touched && !fg.controls.billable.valid" class="merge-expenses--error">
                  Please select a valid payment mode.
                </div>
              </ng-container>
            </ion-col>
          </ion-row>
        </ion-grid>
      </div>

      <ng-container>
        <div
          [ngClass]="{'merge-expenses--internal-block_special': fg.controls.vendor.value}"
          class="merge-expenses--payment-modes merge-expenses--internal-block"
        >
          <app-fy-select
            [enableSearch]="false"
            [label]="'Merchant'"
            [mandatory]="false"
            [nullOption]="false"
            [disabled]="mergedExpenseOptions.tx_vendor.isSame || mergedExpenseOptions.tx_vendor.options.length === 0"
            [options]="mergedExpenseOptions.tx_vendor.options"
            [selectModalHeader]="'Select merchant'"
            formControlName="vendor"
          >
          </app-fy-select>
        </div>
        <div *ngIf="fg.controls.dateOfSpend.touched && !fg.controls.dateOfSpend.valid" class="merge-expenses--error">
          Please select a valid payment mode.
        </div>
      </ng-container>

      <ng-container>
        <div
          [ngClass]="{'merge-expenses--internal-block_special': fg.controls.category.value}"
          class="merge-expenses--payment-modes merge-expenses--internal-block"
        >
          <app-fy-select
            (click)="clickCate()"
            [enableSearch]="false"
            [label]="'Category'"
            [mandatory]="false"
            [nullOption]="false"
            [disabled]="mergedExpenseOptions.tx_org_category_id.isSame || ( mergedExpenseOptions.tx_org_category_id.options && mergedExpenseOptions.tx_org_category_id.options.length === 0)"
            [options]="mergedExpenseOptions.tx_org_category_id.options"
            [selectModalHeader]="'Select category'"
            formControlName="category"
          >
          </app-fy-select>
        </div>
        <div *ngIf="fg.controls.paymentMode.touched && !fg.controls.paymentMode.valid" class="merge-expenses--error">
          Please select a valid payment mode.
        </div>
      </ng-container>

      <ng-container *ngIf="mergedExpenseOptions.tx_tax_amount.options.length">
        <div
          [ngClass]="{'merge-expenses--internal-block_special': fg.controls.tax_amount.value}"
          class="merge-expenses--payment-modes merge-expenses--internal-block"
        >
          <app-fy-select
            [enableSearch]="false"
            [label]="'Tax'"
            [mandatory]="false"
            [nullOption]="false"
            [disabled]="mergedExpenseOptions.tx_tax_amount.isSame || ( mergedExpenseOptions.tx_tax_amount.options && mergedExpenseOptions.tx_tax_amount.options.length === 0)"
            [options]="mergedExpenseOptions.tx_tax_amount.options"
            [selectModalHeader]="'Select Tax'"
            formControlName="tax_amount"
          >
          </app-fy-select>
        </div>
        <div *ngIf="fg.controls.paymentMode.touched && !fg.controls.paymentMode.valid" class="merge-expenses--error">
          Please select a valid payment mode.
        </div>
      </ng-container>
      <!-- <ng-container *ngFor="let customInput of dummyfields">
        <ng-container *ngIf="mergedExpenseOptions['tx_'+customInput.column_name].options.length > 0">
          <div
            [ngClass]="{'merge-expenses--internal-block_special': fg.controls.tax_amount.value}"
            class="merge-expenses--payment-modes merge-expenses--internal-block"
          >
            <app-fy-select
              [enableSearch]="false"
              [label]="customInput.field_name"
              [mandatory]="false"
              [nullOption]="false"
              [selectModalHeader]="'Select Payment Mode'"
              formControlName="tax_amount"
            >
            </app-fy-select>
          </div>
          <div
            *ngIf="fg.controls.paymentMode.touched && !fg.controls.paymentMode.valid"
            class="merge-expenses--error"
          >
            Please select a valid payment mode.
          </div>
        </ng-container>
      </ng-container> -->
      <ng-container *ngIf="customInputs$ | async">
        <ng-container *ngFor="let customInput of this.customInputs$ | async as customInputs">
          <ng-container>
            <div
              [ngClass]="{'merge-expenses--internal-block_special': fg.controls.tax_amount.value}"
              class="merge-expenses--payment-modes merge-expenses--internal-block"
            >
              <app-fy-select
                [enableSearch]="false"
                [label]="customInput.field_name"
                [mandatory]="false"
                [nullOption]="false"
                [disabled]="true || mergedCustomProperties[customInput.field_name].isSame || ( mergedCustomProperties[customInput.field_name].options.length && mergedCustomProperties[customInput.field_name].options.length === 0)"
                [options]="mergedCustomProperties[customInput.field_name].options"
                [selectModalHeader]="'Select Payment Mode'"
                formControlName="tax_amount"
              >
              </app-fy-select>
            </div>
            <div
              *ngIf="fg.controls.paymentMode.touched && !fg.controls.paymentMode.valid"
              class="merge-expenses--error"
            >
              Please select a valid payment mode.
            </div>
          </ng-container>
        </ng-container>
        <!-- <ng-container *ngFor="let customInput of dummyfields">
          <ng-container *ngIf="mergedExpenseOptions['tx_'+customInput.column_name].options.length > 0">
            <div
              [ngClass]="{'merge-expenses--internal-block_special': fg.controls.tax_amount.value}"
              class="merge-expenses--payment-modes merge-expenses--internal-block"
            >
              <app-fy-select
                [enableSearch]="false"
                [label]="customInput.field_name"
                [mandatory]="false"
                [nullOption]="false"
                [selectModalHeader]="'Select Payment Mode'"
                formControlName="tax_amount"
              >
              </app-fy-select>
            </div>
            <div
              *ngIf="fg.controls.paymentMode.touched && !fg.controls.paymentMode.valid"
              class="merge-expenses--error"
            >
              Please select a valid payment mode.
            </div>
          </ng-container>
        </ng-container> -->
      </ng-container>
    </form>
  </ng-container>
</ion-content>
<ng-container *ngIf="fg">
  <ion-footer class="merge-expenses--footer-container">
    <ion-toolbar mode="md" [ngClass]="{'merge-expenses--footer-toolbar__offline': !(isConnected$|async)}">
      <div class="merge-expenses--footer-toolbar">
        <ion-buttons>
          <ion-button
            [disabled]="isMerging"
            [loadingText]="'Merging'"
            [loading]="isMerging"
            appFormButtonValidation
            class="btn-primary"
            (click)="mergeExpense()"
          >
            Save
          </ion-button>
        </ion-buttons>
      </div>
    </ion-toolbar>
  </ion-footer>
</ng-container>
